#Copyright 2025 David Tanzer (business@davidtanzer.net)
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.

#!/usr/bin/env bash

set -euo pipefail

# agnt - Agent management script

LOCK_FILE=".agnt.lock"

show_help() {
    cat << EOF
Usage: agnt <command> [options]

Commands:
    start                      Clear the lock file (asks for confirmation)
    rename <name>              Register the current pane as an agent
    whoami                     Display the current agent name (or 'nobody' if not set)
    list                       List all agent names across all tmux panes
    send <agent> <message>     Send a message to another agent
    help                       Show this help message

Examples:
    agnt start
    agnt rename myagent
    agnt whoami
    agnt list
    agnt send agent2 "Hello from agent1"
    agnt help
EOF
}

# Helper: Get current pane ID
get_current_pane_id() {
    tmux display-message -p '#{pane_id}'
}

# Helper: Check if a pane exists
pane_exists() {
    local pane_id="$1"
    tmux list-panes -a -F "#{pane_id}" | grep -q "^${pane_id}$"
}

# Helper: Read lock file and return entries (format: pane_id:agent_name)
read_lock_file() {
    if [ -f "$LOCK_FILE" ]; then
        cat "$LOCK_FILE"
    fi
}

# Helper: Write entry to lock file (removes old entry for same pane if exists)
write_lock_entry() {
    local pane_id="$1"
    local agent_name="$2"

    # Remove any existing entry for this pane_id
    if [ -f "$LOCK_FILE" ]; then
        grep -v "^${pane_id}:" "$LOCK_FILE" > "${LOCK_FILE}.tmp" || true
        mv "${LOCK_FILE}.tmp" "$LOCK_FILE"
    fi

    # Add new entry
    echo "${pane_id}:${agent_name}" >> "$LOCK_FILE"
}

# Helper: Get agent name for a pane ID
get_agent_name_by_pane_id() {
    local pane_id="$1"
    read_lock_file | grep "^${pane_id}:" | cut -d: -f2
}

# Helper: Get pane ID for an agent name
get_pane_id_by_agent_name() {
    local agent_name="$1"
    read_lock_file | grep ":${agent_name}$" | cut -d: -f1
}

# Helper: Clean stale entries (panes that no longer exist)
clean_stale_entries() {
    if [ ! -f "$LOCK_FILE" ]; then
        return
    fi

    local temp_file="${LOCK_FILE}.tmp"
    > "$temp_file"

    while IFS=: read -r pane_id agent_name; do
        if pane_exists "$pane_id"; then
            echo "${pane_id}:${agent_name}" >> "$temp_file"
        fi
    done < "$LOCK_FILE"

    mv "$temp_file" "$LOCK_FILE"
}

cmd_start() {
    if [ -f "$LOCK_FILE" ]; then
        echo "Warning: This will clear all agent registrations."
        read -p "Are you sure you want to clear the lock file? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm "$LOCK_FILE"
            echo "Lock file cleared."
        else
            echo "Operation cancelled."
            exit 0
        fi
    else
        echo "Lock file does not exist. Nothing to clear."
    fi
}

cmd_rename() {
    if [ $# -eq 0 ]; then
        echo "Error: rename requires a name argument" >&2
        echo "Usage: agnt rename <name>" >&2
        exit 1
    fi

    local name="$1"

    # Check if we're inside a tmux session
    if [ -z "${TMUX:-}" ]; then
        echo "Error: Not in a tmux session" >&2
        exit 1
    fi

    # Get current pane ID
    local pane_id
    pane_id=$(get_current_pane_id)

    # Write to lock file
    write_lock_entry "$pane_id" "$name"

    echo "Registered agent '$name' with pane $pane_id"
}

cmd_whoami() {
    # Check if we're inside a tmux session
    if [ -z "${TMUX:-}" ]; then
        echo "Error: Not in a tmux session" >&2
        exit 1
    fi

    # Get current pane ID
    local pane_id
    pane_id=$(get_current_pane_id)

    # Look up agent name in lock file
    local agent_name
    agent_name=$(get_agent_name_by_pane_id "$pane_id")

    if [ -n "$agent_name" ]; then
        echo "$agent_name"
    else
        echo "nobody"
    fi
}

cmd_list() {
    # Check if tmux is running
    if ! tmux list-sessions &>/dev/null; then
        echo "Error: No tmux sessions found" >&2
        exit 1
    fi

    # Clean stale entries first
    clean_stale_entries

    # Read from lock file, extract agent names, and sort alphabetically
    local agents=()
    while IFS=: read -r pane_id agent_name; do
        if [ -n "$agent_name" ]; then
            agents+=("$agent_name")
        fi
    done < <(read_lock_file)

    if [ ${#agents[@]} -eq 0 ]; then
        echo "No agents found"
    else
        printf '%s\n' "${agents[@]}" | sort
    fi
}

cmd_send() {
    if [ $# -lt 2 ]; then
        echo "Error: send requires an agent name and a message" >&2
        echo "Usage: agnt send <agent> <message>" >&2
        exit 1
    fi

    local target_agent="$1"
    shift
    local message="$*"

    # Check if we're inside a tmux session
    if [ -z "${TMUX:-}" ]; then
        echo "Error: Not in a tmux session" >&2
        exit 1
    fi

    # Get the current agent's name (sender)
    local sender_pane_id
    sender_pane_id=$(get_current_pane_id)
    local sender_name
    sender_name=$(get_agent_name_by_pane_id "$sender_pane_id")
    if [ -z "$sender_name" ]; then
        sender_name="nobody"
    fi

    # Find the target pane ID from lock file
    local target_pane_id
    target_pane_id=$(get_pane_id_by_agent_name "$target_agent")

    if [ -z "$target_pane_id" ]; then
        echo "Error: Agent '$target_agent' not found" >&2
        exit 1
    fi

    # Verify target pane still exists
    if ! pane_exists "$target_pane_id"; then
        echo "Error: Agent '$target_agent' pane no longer exists" >&2
        exit 1
    fi

    # Send the message to the target pane
    # Clear the current prompt line (C-u), send message, then execute with Enter
    local prefixed_message="#[${sender_name}] ${message}"
    tmux send-keys -t "$target_pane_id" C-u
    tmux send-keys -t "$target_pane_id" "$prefixed_message"
    tmux send-keys -t "$target_pane_id" Enter

    echo "Message sent to $target_agent"
}

# Main command dispatcher
main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 1
    fi

    local command="$1"
    shift

    case "$command" in
        start)
            cmd_start "$@"
            ;;
        rename)
            cmd_rename "$@"
            ;;
        whoami)
            cmd_whoami "$@"
            ;;
        list)
            cmd_list "$@"
            ;;
        send)
            cmd_send "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo "Error: Unknown command '$command'" >&2
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
