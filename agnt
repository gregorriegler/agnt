#Copyright 2025 David Tanzer (business@davidtanzer.net)
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.

#!/usr/bin/env bash

set -euo pipefail

# agnt - Agent management script

# Find lock file by traversing up parent directories
# Only searches within $HOME, stops at $HOME
find_lock_file() {
    local current_dir="$PWD"

    # Check if we're under $HOME
    case "$current_dir" in
        "$HOME"*)
            # We're in home directory, search upward
            while true; do
                if [ -f "$current_dir/.agnt.lock" ]; then
                    echo "$current_dir/.agnt.lock"
                    return 0
                fi

                # Stop if we've reached $HOME
                if [ "$current_dir" = "$HOME" ]; then
                    break
                fi

                # Move up one directory
                current_dir=$(dirname "$current_dir")
            done
            ;;
    esac

    # Not found or not in $HOME, return current directory path
    echo "$PWD/.agnt.lock"
}

LOCK_FILE=$(find_lock_file)

show_help() {
    cat << EOF
Usage: agnt <command> [options]

Commands:
    start                      Clear the lock file (asks for confirmation)
    rename <name>              Register the current pane as an agent
    whoami                     Display the current agent name (or 'nobody' if not set)
    list                       List all agent names across all tmux panes
    send <agent> <message>     Send a message to another agent
    purge                      Remove all panes not running 'claude' command
    watch [interval]           Watch the agent list, refreshing every N seconds (default: 3)
    help                       Show this help message

Examples:
    agnt start
    agnt rename myagent
    agnt whoami
    agnt list
    agnt send agent2 "Hello from agent1"
    agnt purge
    agnt watch
    agnt watch 5
    agnt help
EOF
}

# Helper: Get current pane ID
get_current_pane_id() {
    tmux display-message -p '#{pane_id}'
}

# Helper: Check if a pane exists
pane_exists() {
    local pane_id="$1"
    tmux list-panes -a -F "#{pane_id}" | grep -qFx "${pane_id}"
}

# Helper: Get the command running in a pane
get_pane_command() {
    local pane_id="$1"
    tmux display-message -p -t "$pane_id" '#{pane_current_command}' 2>/dev/null || echo ""
}

# Helper: Read lock file and return entries (format: pane_id:agent_name)
read_lock_file() {
    if [ -f "$LOCK_FILE" ]; then
        cat "$LOCK_FILE"
    fi
}

# Helper: Write entry to lock file (removes old entry for same pane if exists)
write_lock_entry() {
    local pane_id="$1"
    local agent_name="$2"

    # Remove any existing entry for this pane_id
    if [ -f "$LOCK_FILE" ]; then
        grep -vF "${pane_id}:" "$LOCK_FILE" > "${LOCK_FILE}.tmp" || true
        mv "${LOCK_FILE}.tmp" "$LOCK_FILE"
    fi

    # Add new entry
    echo "${pane_id}:${agent_name}" >> "$LOCK_FILE"
}

# Helper: Get agent name for a pane ID
get_agent_name_by_pane_id() {
    local pane_id="$1"
    read_lock_file | grep -F "${pane_id}:" | head -n1 | cut -d: -f2 || true
}

# Helper: Get pane ID for an agent name
get_pane_id_by_agent_name() {
    local agent_name="$1"
    read_lock_file | grep -F ":${agent_name}" | head -n1 | cut -d: -f1 || true
}

# Helper: Clean stale entries (panes that no longer exist)
clean_stale_entries() {
    if [ ! -f "$LOCK_FILE" ]; then
        return
    fi

    local temp_file="${LOCK_FILE}.tmp"
    > "$temp_file"

    while IFS=: read -r pane_id agent_name; do
        if pane_exists "$pane_id"; then
            echo "${pane_id}:${agent_name}" >> "$temp_file"
        fi
    done < "$LOCK_FILE"

    mv "$temp_file" "$LOCK_FILE"
}

cmd_start() {
    local local_lock_file=".agnt.lock"

    if [ -f "$local_lock_file" ]; then
        echo "Warning: This will clear all agent registrations in the current directory."
        read -p "Are you sure you want to clear the lock file? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            > "$local_lock_file"
            echo "Lock file cleared."
        else
            echo "Operation cancelled."
            exit 0
        fi
    else
        > "$local_lock_file"
        echo "Created new lock file in current directory."
    fi
}

cmd_rename() {
    if [ $# -eq 0 ]; then
        echo "Error: rename requires a name argument" >&2
        echo "Usage: agnt rename <name>" >&2
        exit 1
    fi

    local name="$1"

    # Validate agent name
    if [ -z "$name" ]; then
        echo "Error: agent name cannot be empty" >&2
        exit 1
    fi

    if [[ "$name" == *:* ]]; then
        echo "Error: agent name cannot contain ':' character" >&2
        exit 1
    fi

    if [[ "$name" == *$'\n'* ]]; then
        echo "Error: agent name cannot contain newlines" >&2
        exit 1
    fi

    # Check if we're inside a tmux session
    if [ -z "${TMUX:-}" ]; then
        echo "Error: Not in a tmux session" >&2
        exit 1
    fi

    # Get current pane ID
    local pane_id
    pane_id=$(get_current_pane_id)

    # Write to lock file
    write_lock_entry "$pane_id" "$name"

    echo "Registered agent '$name' with pane $pane_id"
}

cmd_whoami() {
    # Check if we're inside a tmux session
    if [ -z "${TMUX:-}" ]; then
        echo "Error: Not in a tmux session" >&2
        exit 1
    fi

    # Get current pane ID
    local pane_id
    pane_id=$(get_current_pane_id)

    # Look up agent name in lock file
    local agent_name
    agent_name=$(get_agent_name_by_pane_id "$pane_id")

    if [ -n "$agent_name" ]; then
        echo "$agent_name"
    else
        echo "nobody"
    fi
}

cmd_list() {
    # Check if tmux is running
    if ! tmux list-sessions &>/dev/null; then
        echo "Error: No tmux sessions found" >&2
        exit 1
    fi

    # Read from lock file, extract agent names where pane is running claude
    local agents=()
    while IFS=: read -r pane_id agent_name; do
        if [ -n "$agent_name" ] && pane_exists "$pane_id"; then
            local command
            command=$(get_pane_command "$pane_id")
            if [ "$command" = "claude" ]; then
                agents+=("$agent_name")
            fi
        fi
    done < <(read_lock_file)

    if [ ${#agents[@]} -eq 0 ]; then
        echo "No agents found"
    else
        printf '%s\n' "${agents[@]}" | sort
    fi
}

cmd_purge() {
    # Check if tmux is running
    if ! tmux list-sessions &>/dev/null; then
        echo "Error: No tmux sessions found" >&2
        exit 1
    fi

    if [ ! -f "$LOCK_FILE" ]; then
        echo "No agents registered. Nothing to purge."
        return
    fi

    local temp_file="${LOCK_FILE}.tmp"
    > "$temp_file"

    local removed=0
    local kept=0

    while IFS=: read -r pane_id agent_name; do
        # Check if pane exists
        if ! pane_exists "$pane_id"; then
            echo "Removing '$agent_name' (pane $pane_id no longer exists)"
            removed=$((removed + 1))
            continue
        fi

        # Check what command is running in the pane
        local command
        command=$(get_pane_command "$pane_id")

        if [ "$command" = "claude" ]; then
            # Keep this entry
            echo "${pane_id}:${agent_name}" >> "$temp_file"
            kept=$((kept + 1))
        else
            echo "Removing '$agent_name' (pane $pane_id running '$command', not 'claude')"
            removed=$((removed + 1))
        fi
    done < "$LOCK_FILE"

    mv "$temp_file" "$LOCK_FILE"

    echo ""
    echo "Purge complete: $kept agent(s) kept, $removed agent(s) removed"
}

cmd_watch() {
    local interval=3

    # Parse optional interval argument
    if [ $# -gt 0 ]; then
        if [[ "$1" =~ ^[0-9]+$ ]]; then
            interval="$1"
        else
            echo "Error: interval must be a positive number" >&2
            exit 1
        fi
    fi

    # Check if tmux is running
    if ! tmux list-sessions &>/dev/null; then
        echo "Error: No tmux sessions found" >&2
        exit 1
    fi

    echo "Watching agents (refreshing every ${interval}s, press Ctrl+C to stop)..."
    echo ""

    while true; do
        clear
        echo "=== Agent List (Lock file: $LOCK_FILE) ==="
        echo "Updated: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "Refresh interval: ${interval}s"
        echo ""

        # Read from lock file, extract agent names where pane is running claude
        local agents=()
        while IFS=: read -r pane_id agent_name; do
            if [ -n "$agent_name" ] && pane_exists "$pane_id"; then
                local command
                command=$(get_pane_command "$pane_id")
                if [ "$command" = "claude" ]; then
                    agents+=("$agent_name")
                fi
            fi
        done < <(read_lock_file)

        if [ ${#agents[@]} -eq 0 ]; then
            echo "No agents found"
        else
            printf '%s\n' "${agents[@]}" | sort
        fi

        sleep "$interval"
    done
}

cmd_send() {
    if [ $# -lt 2 ]; then
        echo "Error: send requires an agent name and a message" >&2
        echo "Usage: agnt send <agent> <message>" >&2
        exit 1
    fi

    local target_agent="$1"
    shift
    local message="$*"

    # Check if we're inside a tmux session
    if [ -z "${TMUX:-}" ]; then
        echo "Error: Not in a tmux session" >&2
        exit 1
    fi

    # Get the current agent's name (sender)
    local sender_pane_id
    sender_pane_id=$(get_current_pane_id)
    local sender_name
    sender_name=$(get_agent_name_by_pane_id "$sender_pane_id")
    if [ -z "$sender_name" ]; then
        sender_name="nobody"
    fi

    # Find the target pane ID from lock file
    local target_pane_id
    target_pane_id=$(get_pane_id_by_agent_name "$target_agent")

    if [ -z "$target_pane_id" ]; then
        echo "Error: Agent '$target_agent' not found" >&2
        exit 1
    fi

    # Verify target pane still exists
    if ! pane_exists "$target_pane_id"; then
        echo "Error: Agent '$target_agent' pane no longer exists" >&2
        exit 1
    fi

    # Verify target pane is running claude
    local target_command
    target_command=$(get_pane_command "$target_pane_id")
    if [ "$target_command" != "claude" ]; then
        echo "Error: Agent '$target_agent' is not running claude (running '$target_command')" >&2
        exit 1
    fi

    # Send the message to the target pane
    # Clear the current prompt line (C-u), send message, then execute with Enter
    local prefixed_message="#[${sender_name}] ${message}"
    tmux send-keys -t "$target_pane_id" C-u
    tmux send-keys -t "$target_pane_id" "$prefixed_message"
    tmux send-keys -t "$target_pane_id" Enter

    echo "Message sent to $target_agent"
}

# Main command dispatcher
main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 1
    fi

    local command="$1"
    shift

    case "$command" in
        start)
            cmd_start "$@"
            ;;
        rename)
            cmd_rename "$@"
            ;;
        whoami)
            cmd_whoami "$@"
            ;;
        list)
            cmd_list "$@"
            ;;
        send)
            cmd_send "$@"
            ;;
        purge)
            cmd_purge "$@"
            ;;
        watch)
            cmd_watch "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo "Error: Unknown command '$command'" >&2
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
